<!DOCTYPE html>
<html lang='en'>

<head>

    <title>CalCount</title>

    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/js.cookie.min.js"></script>

    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/style.css">


    <script>
        "use strict";

        function pageLoad() {
            console.log("Invoked pageLoad()");

            const todaysDate = new Date().toISOString().slice(0, 10);  //get today's date as yyyy-mm-dd
            document.getElementById("dateEaten").setAttribute("value", todaysDate);

            getUserName();
            getEatenList();     //get data
        }

        function getUserName() {
            console.log("Invoked getUserName()");
            const url = "/user/name";

            fetch(url, {
                method: "GET"
                //credentials: "include"            // doens't look like you even need this....????
            }).then(response => {                       //returns a promise
                return response.text();                 //now return that promise to text
            }).then(response => {
                if (response.startsWith("Error:")) {   //checks if response from server has a key "Error:"
                    alert(response);
                } else {
                    document.getElementById("firstName").innerHTML = response;           //otherwise put response on page in firstName div
                }
            });
        }


        function getEatenList() {
            console.log("Invoked getEatenList()");

            const dateEaten = document.getElementById("dateEaten").value;   //get value from date picker

            const url = "/eaten/list?dateEaten=" + dateEaten;

            fetch(url, {
                method: "GET",
            }).then(response => {                               //returns a promise (a proxy for a value)
                if (!response.ok) {                             //fetch provides a simple ok flag that indicates whether an HTTP responseâ€™s status code is in the successful range or not
                    throw new Error(response.status + " " + response.statusText);       //if not throw Error with the status text.  example unsupported media when consumes is missing from controller, cookie.js not referenced
                } else {
                    return response.json();                     //if it is successful, convert promise to JSON
                }
            }).then(response => {
                if (response.hasOwnProperty('Error:')) {
                    alert(JSON.stringify(response));
                } else {
                    formatEatenList(response);
                }
            }).catch(error => document.write(error));           //catch the error and overwrite the page with the text


        }

        function formatEatenList(data) {       //data is the data returned from the controller in form of JSON array
            console.log(data);
            let messagesHTML = '<tr><td>Meal Name</td>' +
                '<td>Food</td>' +
                '<td>Servings</td>' +
                '<td>Total Cals</td>' +
                '<td>Total Fat</td>' +
                '<td>Total Saturated Fat</td>' +
                '<td>Total Carbs</td>' +
                '<td>Total Sugar</td>' +
                '<td>Total Fibre</td>' +
                '<td>Total Protein</td>' +
                '<td>Total Salt</td>' +
                '<td>Delete</td></tr>';

            for (let item of data) {
                messagesHTML += `<tr><td>` + item.MealName + `</td>` +
                        `<td>` + item.FoodID + `</td>` +
                        `<td>` + item.Serving + `</td>` +
                        `<td>` + item.TotalCals + `</td>` +
                        `<td>` + item.TotalFat + `</td>` +
                        `<td>` + item.TotalSatFat + `</td>` +
                        `<td>` + item.TotalCarbs + `</td>` +
                        `<td>` + item.TotalSugar + `</td>` +
                        `<td>` + item.TotalFibre + `</td>` +
                        `<td>` + item.TotalProtein + `</td>` +
                        `<td>` + item.TotalSalt + `</td>` +
                        `<td> <button class="deleteEaten btn btn-danger"  data-EatenID="{item.EatenID}" >Delete</button> </td></tr>`;
            }

            document.getElementById('eatenTable').innerHTML = messagesHTML;

            //ToDO rewrite this without Jquery

            // $(".deleteEaten").click(event => {
            //
            //     const eatenID = $(event.target).attr('data-EatenID');
            //
            //     $.ajax({
            //         url: '/eaten/delete',
            //         type: 'POST',
            //         data: {"eatenID": eatenID},
            //         success: response => {
            //             if (response.hasOwnProperty("Error:")) {  //checks if response from server has a key "Error:"
            //                 alert(JSON.stringify(response));        // if it does, convert JSON object to string and alert
            //             } else {
            //                 pageLoad();
            //             }
            //         }
            //     });
            // });


        }

        function logout() {
            console.log("logout - remove cookies and redirect to login page");
            Cookies.remove("sessionToken");
            window.location.href = "login.html";
        }
    </script>

</head>

<body class="center" onload="pageLoad()">

<button class="btn btn-success" onclick='logout();'>LOGOUT</button>


<img src="img/logo.png" alt="CalCount logo" class="logo">

Welcome <span id="firstName"> </span>! <br>
<br>
<button class="button" onclick=window.open("profile.html","_self")> EDIT PROFILE</button>
<BR>
<button class="button" onclick=window.open("trackWeight.html","_self")> TRACK WEIGHT</button>
<BR>
<button class="button" onclick=window.open("trackFood.html","_self")> TRACK Food</button>
<BR>
<p></p>
<form>
    <input type="date" class="form-control" id="dateEaten" onchange="getEatenList()">
</form>

<table id="eatenTable"></table>

<br>


</body>

</html>
<!DOCTYPE html>
<html lang='en'>

<head>

    <title>CalCount</title>

    <script src="/js/jquery-3.3.1.min.js"></script>

    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/js.cookie.min.js"></script>


    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <link rel="stylesheet" href="/css/style.css">


    <script>

        function validateForm() {

            console.log("invoked validateForm()");

            let valid = true;                               //assume form data is valid

            $("#firstNameValidationText,#lastNameValidationText,#targetWeightValidationText,#emailValidationText, #passwordValidationText  ").text("");         //clear these so if form validated again, messages are gone


            if ($("#firstName").val() === "") {
                $("#firstNameValidationText").text("Please enter your first name.");
                valid = false;
            }
            if ($("#lastName").val() === "") {
                $("#lastNameValidationText").text("Please enter your last name.");
                valid = false;
            }
            if ($("#targetWeight").val() === "") {
                $("#targetWeightValidationText").text("Please enter your target weight in kilograms");
                valid = false;
            }

            if (!document.getElementById("email").checkValidity()) {
                valid = false;
                //clear the field because the email address is not valid!
                document.getElementById('email').value = '';
                $("#emailValidationText").text("Please enter a valid email address");
            }

            if (!document.getElementById("password").checkValidity()) {
                valid = false;
                $("#passwordValidationText").text("Please enter password length 8 - 12 chars");
            }

            if (valid === true) {
                postUserAdd();
            }

        }

        // function postUserAdd() {
        //
        //     console.log("invoked postUserAdd()");
        //
        //     const form = $('#newUserForm');
        //
        //     $.ajax({
        //         type: "POST",
        //         url: "/user/add",
        //         data: form.serialize(),  //uses name attribute of input tags
        //         success: response => {
        //             if (response.toString().startsWith('Error:')) {
        //                 alert(response);
        //             } else {
        //                 alert("New account created.  Please log in");
        //                 window.open("login.html", "_self");
        //
        //             }
        //
        //         }
        //     });
        // }


        function postUserAdd() {
            console.log("Invoked postUserAdd() ");

            var url = "/user/add";
            var formData = new FormData(document.getElementById('newUserForm'));

            fetch(url, {
                method: "POST",
                body: formData,
            }).then(response => {
                return response.text()          //method returns a promise, have to return from here to get text
            }).then(response => {
                if (response.startsWith('Error:')) {
                    alert(response);
                } else {
                    alert("New account created.  Please log in");
                    window.open("login.html", "_self");
                }
            });
        }


    </script>

</head>

<body class="center">

<img src="img/logo.png" alt="CalCount logo" class="logo">

Tell us about yourself

<form id="newUserForm">

    <input type="text" class="form-control" id="firstName" name='firstName' placeholder="First name (requried)">
    <div id="firstNameValidationText"></div>

    <input type="text" class="form-control" id="lastName" name='lastName' placeholder="Last name (requried)">
    <div id="lastNameValidationText"></div>

    <input type="text" class="form-control" id="targetWeight" name='targetWeight'
           placeholder="Target Weight in KG (requried)">
    <div id="targetWeightValidationText"></div>

    <input type="text" class="form-control" name='maxCalories' placeholder="Maximum calories per day (requried)">

    <select name="gender" class="form-control">
        <option value="male">Male</option>
        <option value="female">Female</option>
    </select>

    //test field for validation of email address.

    <input type="email" pattern="^\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,3}$"
           required class="form-control" id="email" name="email" placeholder="Enter email">

    <div id="emailValidationText"></div>


    <input type="text" class="form-control" name='userName' placeholder="Username (requried)">

    <input type="password" pattern=".{8,12}"
           required class="form-control" id="password" name='password' placeholder="Password (requried)">
    <div id="passwordValidationText"></div>

</form>


<div id="message"></div>


<div align="center">

    <button id="messageSubmit" onclick='validateForm();' class="button">ADD NEW USER</button>


</div>


</body>

</html>